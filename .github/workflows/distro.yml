name: Distro Tests

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main


jobs:
  distro-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - distro: ubuntu
            image: jrei/systemd-ubuntu
            setup: |
              apt-get update
              apt-get install -y curl sudo
            verify_package: "dpkg -l paretosecurity"
          - distro: fedora
            image: jrei/systemd-fedora
            setup: |
              dnf -y update
              dnf -y install curl which sudo
            verify_package: "rpm -q paretosecurity"
          - distro: arch
            image: carlodepieri/docker-archlinux-systemd
            setup: |
              pacman-key --init
              pacman-key --populate archlinux
              pacman -Syu --noconfirm
              pacman -S --noconfirm curl which sudo
            verify_package: "pacman -Q paretosecurity"

    name: Test on ${{ matrix.distro }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run ${{ matrix.distro }} container with systemd
        run: |
          docker run -d --name runner \
            --privileged \
            --cgroupns=host \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            -v $PWD:/workspace:ro \
            ${{ matrix.image }}

          # Wait for systemd to initialize
          sleep 3

          # Verify systemd is running
          docker exec runner systemctl --version

      - name: Prepare environment
        run: |
          # Distro-specific setup of the runner
          echo "${{ matrix.setup }}" | docker exec -i runner bash

          # Create test user
          docker exec runner useradd -m -s /bin/bash alice
          docker exec runner bash -c "echo 'alice:foobar' | chpasswd"

          # Create config directory for alice
          docker exec -u alice runner mkdir -p /home/alice/.config

      - name: Install ParetoSecurity
        run: |
          docker exec runner bash /workspace/apt/install.sh

      - name: Verify installation
        run: |
          docker exec runner ${{ matrix.verify_package }}
          docker exec runner which paretosecurity
          docker exec -u alice runner paretosecurity --help

      - name: TODO - These should be run automatically by the install script
        run: docker exec runner systemctl enable --now paretosecurity.socket

      - name: Verify root helper is installed and ready
        run: |
          # This command returns non-zero if the root helper is not active
          docker exec runner systemctl status paretosecurity.socket --no-pager

      - name: Run security checks
        run: |
          # Disable checks that are expected to fail in container
          docker exec -u alice runner paretosecurity config disable 37dee029-605b-4aab-96b9-5438e5aa44d8  # screenlock
          docker exec -u alice runner paretosecurity config disable c96524f2-850b-4bb9-abc7-517051b6c14e  # secureboot
          docker exec -u alice runner paretosecurity config disable 21830a4e-84f1-48fe-9c5b-beab436b2cdb  # luks
          docker exec -u alice runner paretosecurity config disable f962c423-fdf5-428a-a57a-827abc9b253e  # password manager
          docker exec -u alice runner paretosecurity config disable 4ced961d-7cfc-4e7b-8f80-195f6379446e  # remote login
          docker exec -u alice runner paretosecurity config disable 25443ceb-c1ec-408c-b4f3-2328ea0c84e1  # docker
          docker exec -u alice runner paretosecurity config disable da4edd80-6af0-4fb3-9fc7-f9a0e9d07f3b  # sshd config
          docker exec -u alice runner paretosecurity config disable 2e46c89a-5461-4865-a92e-3b799c12034a  # firewall
          docker exec -u alice runner paretosecurity config disable 7436553a-ae52-479b-937b-2ae14d15a520  # application updates

          # Run checks
          docker exec -u alice runner paretosecurity check

      - name: Cleanup
        if: always()
        run: |
          docker stop runner || true
          docker rm runner || true