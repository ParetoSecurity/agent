name: Update supported distros

on:
    schedule:
        - cron: '30 6 * * 1' # Runs every Monday at 8:30 AM CEST (6:30 UTC)
    workflow_dispatch: # Allow manual triggering

jobs:
    update_distros:
        runs-on: ubuntu-latest

        permissions:
          contents: write
          pull-requests: write
          actions: write
          issues: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.WORKFLOW_TOKEN }}
              
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                python-version: '3.13' 

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install requests pyyaml ruamel.yaml

            - name: Update supported distros
              id: update
              run: |
                # Run the update script and capture output
                OUTPUT=$(python scripts/update_supported_distros.py 2>&1)
                echo "$OUTPUT"
                
                # Check if any changes were made
                if git diff --quiet; then
                  echo "No changes detected"
                  echo "changes_made=false" >> $GITHUB_OUTPUT
                else
                  echo "Changes detected"
                  echo "changes_made=true" >> $GITHUB_OUTPUT
                  
                  # Extract added/removed distros from output for PR description
                  ADDED=$(echo "$OUTPUT" | grep "Adding new distro version:" | sed 's/Adding new distro version: /- /g' | sed 's/ to the matrix.//g')
                  REMOVED=$(echo "$OUTPUT" | grep "is not supported, removing" | sed 's/The /- /g' | sed 's/ distro is not supported, removing from the matrix.//g')
                  
                  # Save for PR description
                  {
                    echo "pr_description<<EOF"
                    echo "Update supported Linux distribution versions based on https://endoflife.date/"
                    echo ""
                    if [ -n "$ADDED" ]; then
                      echo "### Added distros:"
                      echo "$ADDED"
                      echo ""
                    fi
                    if [ -n "$REMOVED" ]; then
                      echo "### Removed distros (reached end-of-life):"
                      echo "$REMOVED"
                      echo ""
                    fi
                    echo "EOF"
                  } >> $GITHUB_OUTPUT
                fi

            - name: Create branch and commit changes
              if: steps.update.outputs.changes_made == 'true'
              env:
                WORKFLOW_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
              run: |
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                BRANCH_NAME="update/distro_versions-$(date +%s)"
                git checkout -b $BRANCH_NAME
                git add .github/workflows/distro.yml
                git commit -m "Update supported distro versions"
                git push https://x-access-token:$WORKFLOW_TOKEN@github.com/${{ github.repository }}.git $BRANCH_NAME
                echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
              id: git_ops

            - name: Create Pull Request
              if: steps.update.outputs.changes_made == 'true'
              run: |
                # Get repository info
                REPO_OWNER=$(echo ${{ github.repository }} | cut -d'/' -f1)
                REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
                
                # Prepare PR body with proper JSON escaping
                PR_BODY=$(echo "${{ steps.update.outputs.pr_description }}" | jq -Rs .)
                
                # Create pull request using GitHub API
                curl -L \
                  -X POST \
                  -H "Accept: application/vnd.github+json" \
                  -H "Authorization: Bearer ${{ secrets.WORKFLOW_TOKEN }}" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/pulls \
                  -d "{
                    \"title\": \"Update versions of distros we test against\",
                    \"body\": ${PR_BODY},
                    \"head\": \"${{ steps.git_ops.outputs.branch_name }}\",
                    \"base\": \"main\"
                  }"

            - name: On failure
              if: failure()
              uses: actions/github-script@v7
              with:
                script: |
                  const workflow_url = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: '[Bug] Update Supported Distros workflow failed',
                    assignees: ['majarovtar', 'zupo'],
                    body: `The automated workflow to update supported Linux distros has failed.
                    
                    **Workflow Run:** ${workflow_url}
                    **Branch:** ${context.ref}
                    **Commit:** ${context.sha}
                    
                    Please check the workflow logs for details about what went wrong.
                    
                    This workflow attempts to:
                    - Check for new distro versions on endoflife.date
                    - Update the distro.yml file
                    - Create a pull request with the changes
                    
                    Possible failure reasons:
                    - Network issues accessing the API
                    - Token permission issues
                    - Changed path of the distro.yml file`,
                    labels: ['bug', 'automation']
                  });
